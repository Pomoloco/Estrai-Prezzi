<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Storico & Confronto Prezzi — WebApp</title>
  <link rel="stylesheet" href="styles.css" />
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
</head>
<body>
  <header>
    <h1>Storico & Confronto Prezzi</h1>
    <p class="sub">Carica fatture PDF → Estrazione completa → Storico cumulativo → Confronto prezzi → Export Excel</p>
  </header>

  <main>
    <section class="card">
      <h2>1) Carica fatture PDF</h2>
      <input type="file" id="pdfInput" accept="application/pdf" multiple />
      <div class="row">
        <label>Fornitore:</label>
        <input type="text" id="supplier" placeholder="Es. Brendolan Alimentari SRL" />
      </div>
      <div class="row">
        <button id="btnParse">Estrai prodotti</button>
        <button id="btnClearLast">Annulla ultima importazione</button>
        <button id="btnResetAll" class="danger">Azzeramento completo</button>
      </div>
      <p class="hint">La data documento viene letta dal PDF (se presente nel testo o nel nome file). In alternativa puoi impostarla manualmente dal pannello avanzato.</p>
      <details class="advanced">
        <summary>Opzioni avanzate</summary>
        <div class="row">
          <label>Data documento (override):</label>
          <input type="date" id="manualDate" />
        </div>
        <div class="row">
          <label>Regex riga prodotto (avanzato):</label>
          <input type="text" id="rowRegex" value="^(\d{5,7})\s+(.+?)\s+(\d+[\.,]\d{2})$" />
        </div>
        <p class="hint">Il parser predefinito riconosce righe tipo: <code>806133  ACQUA GOCCIA ...  0,94</code></p>
      </details>
    </section>

    <section class="card">
      <h2>2) Risultati ultimo documento</h2>
      <div id="lastDocMeta"></div>
      <div id="tableLastDoc" class="table-wrap"></div>
    </section>

    <section class="card">
      <h2>3) Storico cumulativo (localStorage)</h2>
      <div class="row">
        <button id="btnExportExcel">Esporta Excel (3 fogli con auto-fit)</button>
      </div>
      <div id="tableHistory" class="table-wrap"></div>
    </section>

    <section class="card">
      <h2>4) Confronto prezzi (solo variazioni + nuovi)</h2>
      <div id="tableDelta" class="table-wrap"></div>
    </section>
  </main>

  <footer>
    <small>© 2025 — WebApp statica pronta per Netlify. I dati sono salvati nel tuo browser (localStorage).</small>
  </footer>

  <script src="app.js"></script>
</body>
</html>
